apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: keycloak
  namespace: hudhud
spec:
  values:
    image:
      registry: docker.io
      repository: bitnami/keycloak
      tag: 22.0.1
    auth:
      adminUser: admin
    ## @param production Run Keycloak in production mode. TLS configuration is required except when using proxy=edge.
    ##
    production: false
    ## @param proxy reverse Proxy mode edge, reencrypt, passthrough or none
    ## ref: https://www.keycloak.org/server/reverseproxy
    ##
    proxy: edge
    ## @param httpRelativePath Set the path relative to '/' for serving resources. Useful if you are migrating from older version which were using '/auth/'
    ## ref: https://www.keycloak.org/migration/migrating-to-quarkus#_default_context_path_changed
    ##
    httpRelativePath: "/"
    ## Keycloak Service Discovery settings
    ## ref: https://github.com/bitnami/containers/tree/main/bitnami/keycloak#cluster-configuration
    ##
    ## @param configuration Keycloak Configuration. Auto-generated based on other parameters when not specified
    ## Specify content for keycloak.conf
    ## NOTE: This will override configuring Keycloak based on environment variables (including those set by the chart)
    ## The keycloak.conf is auto-generated based on other parameters when this parameter is not specified
    ##
    ## Example:
    ## configuration: |-
    ##    foo: bar
    ##    baz:
    ##
    configuration: ""
    ## @param existingConfigmap Name of existing ConfigMap with Keycloak configuration
    ## NOTE: When it's set the configuration parameter is ignored
    ##
    existingConfigmap: ""
    ## @param extraStartupArgs Extra default startup args
    ##
    extraStartupArgs: ""
    ## @param initdbScripts Dictionary of initdb scripts
    ## Specify dictionary of scripts to be run at first boot
    ## ref: https://github.com/bitnami/containers/tree/main/bitnami/keycloak#initializing-a-new-instance
    ## Example:
    ## initdbScripts:
    ##   my_init_script.sh: |
    ##      #!/bin/bash
    ##      echo "Do something."
    ##
    initdbScripts: {}
    ## @param initdbScriptsConfigMap ConfigMap with the initdb scripts (Note: Overrides `initdbScripts`)
    ##
    initdbScriptsConfigMap: ""
    ## @param command Override default container command (useful when using custom images)
    ##
    command: []
    ## @param args Override default container args (useful when using custom images)
    ##
    args: []
    ## @param extraEnvVars Extra environment variables to be set on Keycloak container
    ## Example:
    ## extraEnvVars:
    ##   - name: FOO
    ##     value: "bar"
    ##
    extraEnvVars: []
    ## @param extraEnvVarsCM Name of existing ConfigMap containing extra env vars
    ##
    extraEnvVarsCM: ""
    ## @param extraEnvVarsSecret Name of existing Secret containing extra env vars
    ##
    extraEnvVarsSecret: ""

    ## @section Keycloak statefulset parameters

    ## @param replicaCount Number of Keycloak replicas to deploy
    ##
    replicaCount: 1
    ## @param containerPorts.http Keycloak HTTP container port
    ## @param containerPorts.https Keycloak HTTPS container port
    ## @param containerPorts.infinispan Keycloak infinispan container port
    ##
    containerPorts:
      http: 8080
      https: 8443
      infinispan: 7800
    ## @param extraContainerPorts Optionally specify extra list of additional port-mappings for Keycloak container
    ##
    extraContainerPorts: []

    ## Keycloak pods' SecurityContext
    ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-pod
    ## @param podSecurityContext.enabled Enabled Keycloak pods' Security Context
    ## @param podSecurityContext.fsGroup Set Keycloak pod's Security Context fsGroup
    ##
    podSecurityContext:
      enabled: true
      fsGroup: 1001
    ## Keycloak containers' Security Context
    ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container
    ## @param containerSecurityContext.enabled Enabled Keycloak containers' Security Context
    ## @param containerSecurityContext.runAsUser Set Keycloak container's Security Context runAsUser
    ## @param containerSecurityContext.runAsNonRoot Set Keycloak container's Security Context runAsNonRoot
    ##
    containerSecurityContext:
      enabled: true
      runAsUser: 1001
      runAsNonRoot: true
    ## Keycloak resource requests and limits
    ## ref: https://kubernetes.io/docs/user-guide/compute-resources/
    ## @param resources.limits The resources limits for the Keycloak containers
    ## @param resources.requests The requested resources for the Keycloak containers
    ##
    resources:
      limits: {}
      requests: {}
    ## Configure extra options for Keycloak containers' liveness, readiness and startup probes
    ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes
    ## @param livenessProbe.enabled Enable livenessProbe on Keycloak containers
    ## @param livenessProbe.initialDelaySeconds Initial delay seconds for livenessProbe
    ## @param livenessProbe.periodSeconds Period seconds for livenessProbe
    ## @param livenessProbe.timeoutSeconds Timeout seconds for livenessProbe
    ## @param livenessProbe.failureThreshold Failure threshold for livenessProbe
    ## @param livenessProbe.successThreshold Success threshold for livenessProbe
    ##
    livenessProbe:
      enabled: true
      initialDelaySeconds: 300
      periodSeconds: 1
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1
    ## @param readinessProbe.enabled Enable readinessProbe on Keycloak containers
    ## @param readinessProbe.initialDelaySeconds Initial delay seconds for readinessProbe
    ## @param readinessProbe.periodSeconds Period seconds for readinessProbe
    ## @param readinessProbe.timeoutSeconds Timeout seconds for readinessProbe
    ## @param readinessProbe.failureThreshold Failure threshold for readinessProbe
    ## @param readinessProbe.successThreshold Success threshold for readinessProbe
    ##
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 1
      failureThreshold: 3
      successThreshold: 1
    ## When enabling this, make sure to set initialDelaySeconds to 0 for livenessProbe and readinessProbe
    ## @param startupProbe.enabled Enable startupProbe on Keycloak containers
    ## @param startupProbe.initialDelaySeconds Initial delay seconds for startupProbe
    ## @param startupProbe.periodSeconds Period seconds for startupProbe
    ## @param startupProbe.timeoutSeconds Timeout seconds for startupProbe
    ## @param startupProbe.failureThreshold Failure threshold for startupProbe
    ## @param startupProbe.successThreshold Success threshold for startupProbe
    ##
    startupProbe:
      enabled: false
      initialDelaySeconds: 30
      periodSeconds: 5
      timeoutSeconds: 1
      failureThreshold: 60
      successThreshold: 1
    ## @param customLivenessProbe Custom Liveness probes for Keycloak
    ##
    customLivenessProbe: {}
    ## @param customReadinessProbe Custom Rediness probes Keycloak
    ##
    customReadinessProbe: {}
    ## @param customStartupProbe Custom Startup probes for Keycloak
    ##
    customStartupProbe: {}
    ## @param lifecycleHooks LifecycleHooks to set additional configuration at startup
    ##
    lifecycleHooks: {}
    ## @param hostAliases Deployment pod host aliases
    ## https://kubernetes.io/docs/concepts/services-networking/add-entries-to-pod-etc-hosts-with-host-aliases/
    ##
    hostAliases: []
    ## @param podLabels Extra labels for Keycloak pods
    ## ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/
    ##
    podLabels: {}
    ## @param podAnnotations Annotations for Keycloak pods
    ## ref: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/
    ##
    podAnnotations: {}
    ## @param podAffinityPreset Pod affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
    ## ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity
    ##
    podAffinityPreset: ""
    ## @param podAntiAffinityPreset Pod anti-affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
    ## Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity
    ##
    podAntiAffinityPreset: soft
    ## Node affinity preset
    ## Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity
    ##
    nodeAffinityPreset:
      ## @param nodeAffinityPreset.type Node affinity preset type. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
      ##
      type: ""
      ## @param nodeAffinityPreset.key Node label key to match. Ignored if `affinity` is set.
      ## E.g.
      ## key: "kubernetes.io/e2e-az-name"
      ##
      key: ""
      ## @param nodeAffinityPreset.values Node label values to match. Ignored if `affinity` is set.
      ## E.g.
      ## values:
      ##   - e2e-az1
      ##   - e2e-az2
      ##
      values: []
    ## @param affinity Affinity for pod assignment
    ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
    ##
    affinity: {}
    ## @param nodeSelector Node labels for pod assignment
    ## ref: https://kubernetes.io/docs/user-guide/node-selection/
    ##
    nodeSelector: {}
    ## @param tolerations Tolerations for pod assignment
    ## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/
    ##
    tolerations: []
    ## @param topologySpreadConstraints Topology Spread Constraints for pod assignment spread across your cluster among failure-domains. Evaluated as a template
    ## Ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#spread-constraints-for-pods
    ##
    topologySpreadConstraints: []
    ## @param podManagementPolicy Pod management policy for the Keycloak statefulset
    ##
    podManagementPolicy: Parallel
    ## @param priorityClassName Keycloak pods' Priority Class Name
    ## ref: https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/
    ##
    priorityClassName: ""
    ## @param schedulerName Use an alternate scheduler, e.g. "stork".
    ## ref: https://kubernetes.io/docs/tasks/administer-cluster/configure-multiple-schedulers/
    ##
    schedulerName: ""
    ## @param terminationGracePeriodSeconds Seconds Keycloak pod needs to terminate gracefully
    ## ref: https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods
    ##
    terminationGracePeriodSeconds: ""
    ## @param updateStrategy.type Keycloak statefulset strategy type
    ## @param updateStrategy.rollingUpdate Keycloak statefulset rolling update configuration parameters
    ## ref: https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies
    ##
    updateStrategy:
      type: RollingUpdate
      rollingUpdate: {}
    ## @param extraVolumes Optionally specify extra list of additional volumes for Keycloak pods
    ##
    extraVolumes: []
    ## @param extraVolumeMounts Optionally specify extra list of additional volumeMounts for Keycloak container(s)
    ##
    extraVolumeMounts: []
    ## @param initContainers Add additional init containers to the Keycloak pods
    ## Example:
    ## initContainers:
    ##   - name: your-image-name
    ##     image: your-image
    ##     imagePullPolicy: Always
    ##     ports:
    ##       - name: portname
    ##         containerPort: 1234
    ##
    initContainers: []
    ## @param sidecars Add additional sidecar containers to the Keycloak pods
    ## Example:
    ## sidecars:
    ##   - name: your-image-name
    ##     image: your-image
    ##     imagePullPolicy: Always
    ##     ports:
    ##       - name: portname
    ##         containerPort: 1234
    ##
    sidecars: []

    ## @section Exposure parameters
    ##

    ## Service configuration
    ##
    service:
      ## @param service.type Kubernetes service type
      ##
      type: ClusterIP
      ## @param service.http.enabled Enable http port on service
      ##
      http:
        enabled: true
      ## @param service.ports.http Keycloak service HTTP port
      ## @param service.ports.https Keycloak service HTTPS port
      ##
      ports:
        http: 80
        https: 443
      ## @param service.nodePorts [object] Specify the nodePort values for the LoadBalancer and NodePort service types.
      ## ref: https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport
      ##
      nodePorts:
        http: ""
        https: ""
      ## @param service.sessionAffinity Control where client requests go, to the same pod or round-robin
      ## Values: ClientIP or None
      ## ref: https://kubernetes.io/docs/user-guide/services/
      ##
      sessionAffinity: None
      ## @param service.sessionAffinityConfig Additional settings for the sessionAffinity
      ## sessionAffinityConfig:
      ##   clientIP:
      ##     timeoutSeconds: 300
      ##
      sessionAffinityConfig: {}
      ## @param service.clusterIP Keycloak service clusterIP IP
      ## e.g:
      ## clusterIP: None
      ##
      clusterIP: ""
      ## @param service.loadBalancerIP loadBalancerIP for the SuiteCRM Service (optional, cloud specific)
      ## ref: https://kubernetes.io/docs/user-guide/services/#type-loadbalancer
      ##
      loadBalancerIP: ""
      ## @param service.loadBalancerSourceRanges Address that are allowed when service is LoadBalancer
      ## https://kubernetes.io/docs/tasks/access-application-cluster/configure-cloud-provider-firewall/#restrict-access-for-loadbalancer-service
      ## Example:
      ## loadBalancerSourceRanges:
      ##   - 10.10.10.0/24
      ##
      loadBalancerSourceRanges: []
      ## @param service.externalTrafficPolicy Enable client source IP preservation
      ## ref https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip
      ##
      externalTrafficPolicy: Cluster
      ## @param service.annotations Additional custom annotations for Keycloak service
      ##
      annotations: {}
      ## @param service.extraPorts Extra port to expose on Keycloak service
      ##
      extraPorts: []
      # DEPRECATED service.extraHeadlessPorts will be removed in a future release, please use service.headless.extraPorts instead
      ## @param service.extraHeadlessPorts Extra ports to expose on Keycloak headless service
      ##
      extraHeadlessPorts: []
      ## Headless service properties
      ##
      headless:
        ## @param service.headless.annotations Annotations for the headless service.
        ##
        annotations: {}
        ## @param service.headless.extraPorts Extra ports to expose on Keycloak headless service
        ##
        extraPorts: []

    ## @section RBAC parameter
    ## Specifies whether a ServiceAccount should be created
    ##
    serviceAccount:
      ## @param serviceAccount.create Enable the creation of a ServiceAccount for Keycloak pods
      ##
      create: true
      ## @param serviceAccount.name Name of the created ServiceAccount
      ## If not set and create is true, a name is generated using the fullname template
      ##
      name: ""
      ## @param serviceAccount.automountServiceAccountToken Auto-mount the service account token in the pod
      ##
      automountServiceAccountToken: true
      ## @param serviceAccount.annotations Additional custom annotations for the ServiceAccount
      ##
      annotations: {}
      ## @param serviceAccount.extraLabels Additional labels for the ServiceAccount
      ##
      extraLabels: {}

    postgresql:
      enabled: false

    ## External PostgreSQL configuration
    ## All of these values are only used when postgresql.enabled is set to false
    ## @param externalDatabase.host Database host
    ## @param externalDatabase.port Database port number
    ## @param externalDatabase.user Non-root username for Keycloak
    ## @param externalDatabase.password Password for the non-root username for Keycloak
    ## @param externalDatabase.database Keycloak database name
    ## @param externalDatabase.existingSecret Name of an existing secret resource containing the database credentials
    ## @param externalDatabase.existingSecretHostKey Name of an existing secret key containing the database host name
    ## @param externalDatabase.existingSecretPortKey Name of an existing secret key containing the database port
    ## @param externalDatabase.existingSecretUserKey Name of an existing secret key containing the database user
    ## @param externalDatabase.existingSecretDatabaseKey Name of an existing secret key containing the database name
    ## @param externalDatabase.existingSecretPasswordKey Name of an existing secret key containing the database credentials
    ##
    externalDatabase:
      existingSecret: "keycloak-database-credentials"
      existingSecretHostKey: "host"
      existingSecretPortKey: "port"
      existingSecretUserKey: "user"
      existingSecretDatabaseKey: "name"
      existingSecretPasswordKey: "password"

    ## @section Keycloak Cache parameters

    ## Keycloak cache configuration
    ## ref: https://www.keycloak.org/server/caching
    ## @param cache.enabled Switch to enable or disable the keycloak distributed cache for kubernetes.
    ## NOTE: Set to false to use 'local' cache (only supported when replicaCount=1).
    ## @param cache.stackName Set infinispan cache stack to use
    ## @param cache.stackFile Set infinispan cache stack filename to use
    ##
    cache:
      enabled: true
      stackName: kubernetes
      stackFile: ""

    ## @section Keycloak Logging parameters

    ## Keycloak logging configuration
    ## ref: https://www.keycloak.org/server/logging
    ## @param logging.output Alternates between the default log output format or json format
    ## @param logging.level Allowed values as documented: FATAL, ERROR, WARN, INFO, DEBUG, TRACE, ALL, OFF
    ##
    logging:
      output: default
      level: INFO
  chart:
    spec:
      chart: keycloak
      sourceRef:
        kind: HelmRepository
        name: bitnami
      version: 16.1.1
  interval: 1m0s


